(function(h){var k=h.requires("BaseControl"),g=h.requires("jquery"),f=h.requires("underscore"),d,k=k.extend(function(k){var l={DOWN:40,UP:38,ENTER:13,ESC:27},m={dependencies:["scripts/shared/KeyEvents"],styledListSelector:null,selectionStateField:null,CLASSES:{OPEN:"open",HIGHLIGHTED:"highlighted",SELECTED:"selected"},NAMESPACE:"AccessibleStyledDropdown"};return{beforeDecoration:function(){this._config=f.defaults(this._config,m);this._state=0;this._baseId=this._$el.get(0).id||this._createUniqueId();
this._$el.attr("id",this._baseId);this._onBodyClick=f.bind(this._onBodyClick,this);this._onListClick=f.bind(this._onListClick,this);this._$body=g(document.body);if(!this._$el.data("li-styled-list")&&!this._config.styledListSelector)throw"Styled list selector must be set.";this._$styledList=this._config.styledListSelector?g(this._config.styledListSelector):g(this._$el.data("li-styled-list"));this._$styledListLis=this._$styledList.children("li");this._numberOfOptions=this._$styledListLis.size();for(var a=
0;a<this._numberOfOptions;a++)this._$styledListLis[a].id=this._baseId+"-option-"+a;this._currentlySelectedIndex=this._$styledList.find("."+this._config.CLASSES.SELECTED).index()||0;this._currentlyHighlightedIndex=this._currentlySelectedIndex=-1<this._currentlySelectedIndex?this._currentlySelectedIndex:0;this._suggestedText="";this._options=f.map(this._$styledList.children("li"),function(a){return g(a).text().toLowerCase().replace(/[\-#$\^*()+\[\]{}|\\,.?\s]/g,"\\$\x26")});this._$highlightedLi=this._$selectedLi=
this._$styledListLis.eq(this._currentlySelectedIndex);this._$stateField=g(this._config.selectionStateField);this.highlightByIndex(this._currentlySelectedIndex);this._ariaBootstrap()},afterLoad:function(){d=h.requires("keyEvents");d._config.decorators=["scripts/shared/KeyEvents/KeyPress"];return d.decorate().then(function(){d.initKeyPress()})},attachEventListeners:function(){this._$el.on("click",f.bind(this._onTargetClick,this));this._$el.on("focus",f.bind(this._onTargetFocus,this));this._$el.on("blur",
f.bind(this._onTargetBlur,this))},open:function(){this._state=1;this._setShowingHandlers();this._toggleStyledList(this._state)},close:function(){this._state=0;this._removeShowingHandlers();this._toggleStyledList(this._state)},highlightNextItem:function(){this._currentlyHighlightedIndex=this._currentlyHighlightedIndex===this._numberOfOptions-1?0:this._currentlyHighlightedIndex+1;this.highlightByIndex(this._currentlyHighlightedIndex)},highlightPrevItem:function(){this._currentlyHighlightedIndex=0===
this._currentlyHighlightedIndex?this._numberOfOptions-1:this._currentlyHighlightedIndex-1;this.highlightByIndex(this._currentlyHighlightedIndex)},highlightByIndex:function(a){if(!(0>a)){var b=this._config.CLASSES.HIGHLIGHTED;this._currentlyHighlightedIndex=a;this._$highlightedLi.removeClass(b);this._$highlightedLi=this._$styledListLis.eq(this._currentlyHighlightedIndex).addClass(b);a=this._$highlightedLi.attr("id");this._$el.attr("aria-activedescendant",a);0===this._state&&this.selectByIndex(this._currentlyHighlightedIndex)}},
selectByIndex:function(a){var b=this._config.CLASSES.SELECTED;this._currentlyHighlightedIndex=this._currentlySelectedIndex=a;this._$selectedLi.removeClass(b);this._$selectedLi.attr("aria-selected","false");this._$selectedLi=this._$styledListLis.eq(this._currentlySelectedIndex).addClass(b);b=this._$selectedLi.text();this._$stateField.text(b);this._$el.attr("aria-valuenow",b);this._$selectedLi.attr("aria-selected","true");this.optionSelected(this._$styledListLis.eq(a),a);1===this._state&&this.close()},
selectHighlightedItem:function(){this.selectByIndex(this._currentlyHighlightedIndex)},queryFromKeypress:function(a){this._suggestedText+=a;var b=this.indexFromQuery(this._suggestedText);0>b&&(b=this.nextIndexFromCharacter(a,this._currentlyHighlightedIndex));this.highlightByIndex(b);this._lastChar=a;this._keydownTimeout();return b},indexFromQuery:function(a){var b=this._options,c,e;c=0;for(e=b.length;c<e;c++)if(0===b[c].indexOf(a))return c;return-1},nextIndexFromCharacter:function(a,b){if(this._lastChar===
a){for(var c=this._options,e=b+1,d=e,f=c.length;e<f;e++)if(0===c[e].indexOf(a))return e;for(e=0;e<d;e++)if(0===c[e].indexOf(a))return e}return-1},optionSelected:function(a,b){},_createUniqueId:function(){var a=this._config.NAMESPACE+"_"+f.uniqueId();this._$el.attr("id",a);return a},_ariaBootstrap:function(){this._$el.attr("aria-controls",this._$styledList.attr("id")).attr("role","combobox").attr("haspopup","true");this._$styledList.attr("aria-level","2").attr("role","listbox");this._$selectedLi.attr("aria-selected",
"true");this._$styledListLis.attr("role","option")},_onTargetClick:function(a){var b;b=f.clone(a);a.preventDefault();a.stopPropagation();1===this._state?this.close():(this.open(),this._$el.parent().trigger(b,this))},_onTargetFocus:function(a){a.stopPropagation();a="#"+this._$el.get(0).id;d.on(a,"keypress",this._onKeypress,this);d.on(a,"up",this._onKeydown,this);d.on(a,"down",this._onKeydown,this);d.on(a,"enter",this._onKeydown,this)},_onTargetBlur:function(a){a.stopPropagation();a="#"+this._$el.get(0).id;
d.off(a,"keypress",this._onKeypress,this);d.off(a,"up",this._onKeydown,this);d.off(a,"down",this._onKeydown,this);d.off(a,"enter",this._onKeydown,this)},_onKeydown:function(a,b){var c=b.which;c===l.ENTER?(b.preventDefault(),0===this._state?this.open():this.selectHighlightedItem()):c===l.DOWN?(b.preventDefault(),this.highlightNextItem()):c===l.UP?(b.preventDefault(),this.highlightPrevItem()):c===l.ESCAPE&&(b.preventDefault(),this.close());0===this._state&&this.selectByIndex(this._currentlyHighlightedIndex)},
_onKeypress:function(a,b){var c=String.fromCharCode(b.which);this.queryFromKeypress(c)},_onBodyClick:function(a,b){1===this._state&&b!==this&&this.close()},_toggleStyledList:function(a){var b=this._$highlightedLi.attr("id");0<a?(this._$styledList.addClass(this._config.CLASSES.OPEN),this._$styledList.attr("aria-hidden","false"),this._$el.attr("aria-activedescendant",b),this._$el.attr("aria-expanded","true"),this._$selectedLi.addClass(this._config.CLASSES.HIGHLIGHTED)):(this._$styledList.removeClass(this._config.CLASSES.OPEN),
this._$styledList.attr("aria-hidden","true"),this._$el.attr("aria-expanded","false"))},_setShowingHandlers:function(){this._$body.on("click",this._onBodyClick);this._$styledList.on("mouseenter","li",this._onListMouseenter).on("mouseleave","li",this._onListMouseleave).on("click","li",this._onListClick)},_removeShowingHandlers:function(){this._$body.off("click",this._onBodyClick);this._$styledList.off("mouseenter","li",this._onListMouseenter).off("mouseleave","li",this._onListMouseleave).off("click",
"li",this._onListClick)},_onListMouseenter:function(a){var b=this._config.CLASSES.HIGHLIGHTED;this._$styledListLis.removeClass(b);g(a.target).addClass(b)},_onListMouseleave:function(a){g(a.target).removeClass(this._config.CLASSES.HIGHLIGHTED)},_onListClick:function(a){this.selectByIndex(g(a.target).index());this.close()},_keydownTimeout:function(){this._anTimeout&&clearTimeout(this._anTimeout);this._anTimeout=setTimeout(f.bind(function(){this._suggestedText="";this._lastChar=null},this),300)}}});
h.exports("AccessibleStyledDropdown",k)})(LIModules);(function(b){var c=b.requires("jquery");b.exports("Spinner",{showSpinner:function(a){0===a.children(".spinner").length?a.append(c('\x3cdiv class\x3d"spinner"\x3e\x3c/div\x3e')).children(".spinner").height(a.prop("scrollHeight")):a.children(".spinner").show().height(a.prop("scrollHeight"))},hideSpinner:function(a){a.children(".spinner").hide()}})})(window.LIModules);(function(m){var c=window.jQuery||m("jquery");m=LIModules.imports("BaseControl");var v=LIModules.imports("Events"),w=LIModules.imports("parseQueryString"),r,n;m=m.extend(function(m){var b,k,l,u,f,s,d,e,p,q,t,h;f={pub:{PREVENT_ACTION_SEL:".signup-button"},cxn1:{PREVENT_ACTION_SEL:".endorse-button,.profile-actions.view-actions,.endorse-user a,.groups-join,.select-follow-action,.social-container .comment-btn,.social-container .actions"},EXCEPTION_SELECTOR:".always-allow",NAV_HEIGHT:42,NAV_WITH_SUBNAV_HEIGHT:71};
return{beforeDecoration:function(){b=this;l=this._config.currentCtx;this._config.adContainerId&&(h={$el:c(this._config.adContainerId)},h.height=h.$el.outerHeight());f[l]&&(s=f[l].PREVENT_ACTION_SEL);b._initCtxBanner();b._initDropDown()},attachEventListeners:function(){var a="globalnav:show globalnav:hide globalnav:hideStart globalnav:showStop";h&&(a+=" globalnav:showStart");v.bind(a,b._repositionBanner);s&&document.addEventListener&&c("body").get(0).addEventListener("click",function(a){var d=c(a.target);
d.closest(s).length&&!d.closest(f.EXCEPTION_SELECTOR).length&&(a.preventDefault(),a.stopImmediatePropagation(),b._openActionDisabledDlg())},!0)},_initCtxBanner:function(){t=c("html").is(".os-ios, .ios-android");k=c("#preview-ctx");"fixed"===c("#responsive-nav-scrollable,#header-navigation").css("position")&&b._repositionBanner({name:"globalnav:hide"});h&&b._repositionBannerWithAd();k.insertAfter(c("#header,#layout-header"))},_repositionBanner:function(a){k&&k.length&&!t&&(h?(b._repositionBannerWithAd(),
b._bindScrollEvent()):k.css("top","globalnav:show"===a.name||"globalnav:showStop"===a.name?f.NAV_WITH_SUBNAV_HEIGHT+"px":f.NAV_HEIGHT+"px"))},_repositionBannerWithAd:function(){if(t)return!1;var a="fixed"===c("#responsive-nav-scrollable,#header-navigation").css("position")?f.NAV_HEIGHT:f.NAV_WITH_SUBNAV_HEIGHT,g=Math.max(0,c(window).scrollTop()),g=h.height-g,a=g>a?g:a;k.css("top",a+"px");a!==f.NAV_HEIGHT&&a!==h.height||b._unbindScrollEvent()},_unbindScrollEvent:function(){c(window).off("scroll",b._repositionBannerWithAd)},
_bindScrollEvent:function(){b._unbindScrollEvent();c(window).on("scroll",b._repositionBannerWithAd)},_initDropDown:function(){var a=c("#ctx-dropdown-target"),g;l&&(g=k.find("#"+l+"-opt"),g.addClass("selected"),u=g.parent().children().index(g));r||(r=LIModules.imports("AccessibleStyledDropdown"));(new r(a,{selectionStateField:"#ctx-dropdown-state"})).clobber("optionSelected",b._optionSelected)},_optionSelected:function(a,c){var d=a.data("href"),f=a.data("ppv"),e=w(d);"you"===l&&!e.vpa||l===e.vpa||
("pub"!==e.vpa||f?window.location=d:(b._openPublicProfileDisabledDlg(),this.selectByIndex(u)))},_openActionDisabledDlg:function(){var a=LIModules.imports("ModalDialogBox");d||(d=new a(c(),{width:460,title:b._config.actionDisabledDlgTitle,decorators:["scripts/shared/Dialog/AjaxDustLoading"],dependencies:["scripts/shared/Spinner"],dustContentTemplate:"tl/apps/profile/preview_profile/action_disabled_dialog",templateDataUrl:b._config.actionDisabledUrl,dataContextPath:"content"}),d.clobber("_loadContent",
b._loadNoActionDlgContent));d.isReady.then(function(){b._trackActivity("prof-preview-modal-action_disabled");d.open()})},_loadNoActionDlgContent:function(){p||(n||(n=LIModules.imports("Spinner")),n.showSpinner(d._$dialog.find(".dialog-body")));return c.when(this.loadDependencies([d._config.dustContentTemplate]),this._getNoActionDlgContent(),this.loadCss(["css!scss/apps/profile/v2/preview_profile/disabled_dialog"]))},_getNoActionDlgContent:function(){var a=this._config.locale;return p?p:c.ajax({url:d._href,
success:function(b){b.content.url_edit=LI.addParams(b.content.url_edit,{locale:a});p=c.Deferred().resolve([b]);return b}})},_openPublicProfileDisabledDlg:function(){var a=LIModules.imports("ModalDialogBox");e||(e=new a(c(),{width:500,title:b._config.publicProfileDisabledDlgTitle,decorators:["scripts/shared/Dialog/AjaxDustLoading"],dependencies:["scripts/shared/Spinner"],dustContentTemplate:"tl/apps/profile/preview_profile/public_profile_disabled_dialog",templateDataUrl:b._config.publicProfileDisabledUrl,
dataContextPath:"content"}),e.clobber("_loadContent",b._loadPublicProfileDisabledDlgContent));e.isReady.then(function(){b._trackActivity("prof-preview-modal-public_profile_disabled");e.open()})},_loadPublicProfileDisabledDlgContent:function(){q||(n||(n=LIModules.imports("Spinner")),n.showSpinner(e._$dialog.find(".dialog-body")));return c.when(this.loadDependencies([e._config.dustContentTemplate]),this._getPublicProfileDisabledDlgContent(),this.loadCss(["css!scss/apps/profile/v2/preview_profile/disabled_dialog"]))},
_getPublicProfileDisabledDlgContent:function(){return q?q:c.ajax({url:e._href,success:function(a){q=c.Deferred().resolve([a]);return a}})},_trackActivity:function(a){window.WebTracking&&a&&WebTracking.trackUserAction(a)}}});LIModules.exports("ContextBanner",m)})(window.require);(function(){var d=window.jQuery||require("jquery"),g=window._||require("underscore"),m=window.dust||require("dust"),f=LIModules.imports("BaseControl"),q=LIModules.imports("BalloonCallout"),n=LIModules.imports("injectAlert"),r=LIModules.imports("parseQueryString"),s=LIModules.requires("Events"),k={SAVE_SUCCESS:"FREEMIUM_SAVE_SUCCESS",REMOVE_SUCCESS:"FREEMIUM_REMOVE_SUCCESS"},f=f.extend(function(f){var l,t=["#ad-slot-3","#text-ad-container",".textad"],u=["#preview-ctx"],h=LIModules.imports("MediaServerUploader");
return{beforeLoad:function(){!h&&this._config.selfView&&(this._config.dependencies=["scripts/shared/MediaServerUploader"])},afterLoad:function(){this._useDefaultsIfNeeded();this._renderModule()},setImage:function(a){a.url!==this._currentImage.url&&((this._config.originalIsCustomUpload||this._config.isCustomUpload)&&-1!==a.url.indexOf(".jpg")?(this._currentImage.url=a.url,this._$image.attr("src",this._currentImage.url).show()):this._$image.hide())},_preloadImage:function(a){var b=d.Deferred(),c=new Image,
e=this;c.onerror=function(){e._track("image_load_fail",{imageUrl:a});b.resolve(null)};c.onload=function(){b.resolve(c)};c.src=a;return b.promise()},setPosition:function(a){0<a.offsetY&&(a.offsetY=0);this._setMaxOffset();a.offsetY<this._maxOffset&&(a.offsetY=this._maxOffset);a.offsetY!==this._currentImage.offsetY&&(this._currentImage.offsetY=a.offsetY,this._$image.css("top",this._currentImage.offsetY))},_useDefaultsIfNeeded:function(){l=this._config.templateId||"tl/apps/profile/v2/embed/freemium_profile"},
_renderModule:function(){var a=this,b=function(b,e){b||(a._$body=d("body").prepend(e),a._initModule())};this._config.selfView?d.get(this._config.dataUrl).then(function(c){c.content&&(a._content=c.content.TopcardBackground,a._content.csrfToken=r(a._config.saveUrl).csrfToken,g.extend(a._content,a._config.i18n),m.render(l,a._content,b))},function(){a._showError()}):d(function(){m.render(l,a._config,b)})},_initModule:function(){this._originalMediaId=this._mediaId=this._config.mediaId;this._originalOffsetY=
-this._config.imageData.offsetY;this._config.originalIsCustomUpload=this._config.isCustomUpload;this._currentImage={};this._mediaIdSignature=null;this._cacheNodes();this._attachEventListeners();this._imageLoader=null;this._canUpload=!0;this._config.selfView&&this._initUploader();this._resetModule()},_cacheNodes:function(){this._$win=d(window);this._$doc=d(document);this._$wrap=d("#wrapper");this._$el=d("#freemium-bg");this._$image=this._$el.find(".freemium-bg-image");this._$textAd=d(t.join(","));
this._$hiddenOnEditElements=this._$textAd.add(u.join());this._$header=d("#header,#layout-header");this._$responsiveNav=d("#responsive-nav-scrollable,#header-navigation");this._config.isCustomUpload?this._$body.addClass("freemium-bg"):this._config.selfView&&this._config.uploadOnView&&this._$body.addClass("freemium-bg");this._config.selfView&&(this._$profile=d("#body \x3e .wrapper"),this._$uploadForm=this._$el.find(".freemium-bg-upload-form"),this._$uploadInput=this._$el.find(".freemium-bg-upload-input"),
this._$uploadClone=this._$uploadInput.clone(),this._$saveButton=this._$el.find(".freemium-bg-save-button"),this._$cancelButton=this._$el.find(".freemium-bg-cancel-button"),this._$removeButton=this._$el.find(".remove-image"),this._$editButton=this._$el.find(".freemium-bg-edit-button"),this._$changeArea=this._$el.find(".freemium-bg-change-button"),this._$drag=this._$el.find(".freemium-bg-drag-prompt"))},_attachEventListeners:function(){this._$win.on("scroll",this._onWindowScroll);this._config.selfView&&
(this._$el.on("click",".freemium-bg-upload-input",this._uploadClick).on("change",".freemium-bg-upload-input",this._uploadImage),this._$saveButton.on("click",this._saveImage),this._$cancelButton.on("click",this._resetModule),this._$removeButton.on("click",this._removeImage),this._$editButton.on("click",this._editBgClick),this._$uploadForm.on("mpr-upload-error",this._onUploadError).on("mpr-upload-success",this._onUploadSuccess),this._$doc.on("mousedown",this._onBackgroundMouseDown),this._$win.on("resize",
this._setScalingDimension),this._bindProfileEvents())},_bindProfileEvents:function(){g.has(d.fn,"Profile")?(d.fn.Profile.bind(d.fn.Profile.EVENTS.SWITCH_EDIT,this._onProfileEdit),d.fn.Profile.bind(d.fn.Profile.EVENTS.SWITCH_VIEW,this._onProfileView)):setTimeout(g.bind(this._bindProfileEvents,this),25)},_initUploader:function(){h||(h=LIModules.imports("MediaServerUploader"));this._uploader=new h(this._$uploadForm[0])},_uploadClick:function(a){this._track("custom_bg_browse")},_editBgClick:function(a){this._track("custom_bg_edit");
this._setState("edit");this._enableChangeBgUploader();this._$hiddenOnEditElements.hide()},_uploadImage:function(a){var b;if(b=d(a.currentTarget).val()){b=b.substring(b.lastIndexOf(".")+1).toLowerCase();switch(b){case "gif":case "jpg":case "jpeg":case "png":break;default:this._showError(this._config.errors.media);this._track("custom_bg_fail",{failureType:"INV_MEDIA"});return}if(window.File&&window.FileList&&(a=a.target.files[0],b=Math.max(1048576*(this._config.maxUploadSizeInMB||0),6291456),a.size>
b)){this._showError(this._config.errors.size);this._track("custom_bg_fail",{failureType:"SIZE"});return}this._setState("loading");this._$uploadForm.trigger("submit");this._track("custom_bg_open")}else this._track("custom_bg_cancel")},_setMaxOffset:function(){var a=this._$image.height();this._$image.width();var b=this._$el.height(),c=this._config.selfView;this._maxOffset=b-a;0<=this._maxOffset?(this._maxOffset=0,c&&this._$drag.css("display","none")):c&&this._$drag.css("display","")},_setScalingDimension:function(a){if(null!==
a){var b=g.has(a,"width")?a:this._$image[0];a=b.height;var c=this._$el.height(),b=b.width,e=this._$el.width();a/b<c/e?this._$image.addClass("freemium-bg-scale-height"):b<e&&this._$image.removeClass("freemium-bg-scale-height");"edit"===this._state&&this._enableChangeBgUploader();this._setMaxOffset();this._$image.position().top<this._maxOffset&&this.setPosition({offsetY:this._maxOffset})}},_checkImageSize:function(a){var b=383>a.height;(1260>a.width||b)&&n({message:this._config.i18n.i18n_recommended_size,
type:"warning",dismissable:!0,animate:!0})},_removeImage:function(a){this._track("custom_bg_remove");this._syncBackgroundSettings(!0)},_saveImage:function(a){this._track("custom_bg_save");this._syncBackgroundSettings()},_syncBackgroundSettings:function(a){var b=this,c=!0===a,e=!c,p=function(a){"fail"===a.status?(b._showError(),b._track("custom_bg_fail",{failureType:"MUTATOR"}),b._setState("edit")):(b._setState("edit-image"),b._originalMediaId=e?b._mediaId:"",b._originalOffsetY=e?Math.round(b._currentImage.offsetY):
0,b._config.isCustomUpload=e,b._config.originalIsCustomUpload=e,b._disableBgUploader(),b._track("photo_save_success"),s.trigger(c?k.REMOVE_SUCCESS:k.SAVE_SUCCESS),e||b._resetModule())};e||b._config.originalIsCustomUpload?this._mediaId?(this._setState("loading"),e||(b._mediaId=b._config.imageData.defaultImage,b._currentImage.offsetY=0),d.get(b._config.dataUrl).then(function(a){b._content.timestamp=a.content.TopcardBackground.timestamp;b._content.profileVersionTag=a.content.TopcardBackground.profileVersionTag;
b._content.privacySettingsVersionTag=a.content.TopcardBackground.privacySettingsVersionTag}).then(function(){d.ajax(b._config.saveUrl,{type:"POST",headers:{"X-IsAJAXForm":1},data:{bgEnabled:e,mediaID:e?b._mediaId:"",signature:e?b._mediaIdSignature:null,isCustomImage:e,yPos:b._currentImage.offsetY?Math.round(-b._currentImage.offsetY):0,timestamp:b._content.timestamp,changeCount:b._content.changeCount,locale:b._content.locale,profileVersionTag:b._content.profileVersionTag,privacySettingsVersionTag:b._content.privacySettingsVersionTag}}).then(p)})):
(this._track("custom_bg_fail",{failureType:"NULL_MEDIA"}),this._showError()):p({status:"okay"})},_showError:function(a){n({message:a||this._config.errors.defaultErr,type:"error",dismissable:!0,animate:!0})},_resetModule:function(){var a=this,b=this._getMediaUrl(this._originalMediaId),c;this._$hiddenOnEditElements.show();this._config.isCustomUpload=this._config.originalIsCustomUpload;this._config.selfView&&((c=((c=this._isInEditMode())||this._displayUploadOnView())&&this._config.showUploader)?(this._onProfileEdit(),
this._disableBgUploader(),this._config.isCustomUpload?this._setState("edit-image"):(this._setState("upload"),this._enableAddBgUploader())):this._onProfileView());this._config.originalIsCustomUpload&&this._preloadImage(b).then(function(c){a._setScalingDimension(c);a.setImage({url:b});a.setPosition({offsetY:a._originalOffsetY})})},_onUploadError:function(a,b){var c,e={failureType:b.error||"generic",uploadedFilename:this._getUploadedFileName()},d=this;switch(b.error){case "SIZE":c=this._config.errors.size;
break;case "INV_MEDIA":c=this._config.errors.media;break;case "DIMENSION":c=this._config.errors.dimension;break;case "TIME":if(this._canUpload){this._canUpload=!1;e.failureType="TIME_RETRY";this._track("custom_bg_fail",e);this._refreshHashInfo().then(function(){d._$uploadForm.trigger("submit")});return}}this._canUpload=!0;this._track("custom_bg_fail",e);this._showError(c);this._resetUploadInput();this._setState(this._lastState)},_refreshHashInfo:function(){var a=this._$el.find('[name\x3d"upload_info"]');
return d.get(this._config.dataUrl).then(function(b){a.val(b.content.TopcardBackground.hashInfoJS)})},_onUploadSuccess:function(a,b){var c=this._getMediaUrl(b.value),e=this._getUploadedFileName(),d=this;this._canUpload=!0;this._resetUploadInput();this._mediaId=b.value;b.sig&&(this._mediaIdSignature=b.sig);this._preloadImage(c).then(function(a){d._config.isCustomUpload=!0;d._setScalingDimension(a);d.setImage({url:c});d.setPosition({offsetY:0});d._setState("edit");d._checkImageSize(a);d._enableChangeBgUploader();
d._track("photo_upload_success",{returnedFilename:encodeURIComponent(c),uploadedFilename:e})})},_onBackgroundMouseDown:function(a){var b=this._$el.position().top,c=this._$el.outerHeight(!0),b=a.pageY>=b&&a.pageY<=b+c;if("edit"===this._state&&b)return this._maxOffset||this._setMaxOffset(),this._$doc.one("mouseup",this._onBackgroundMouseUp).on("mousemove",this._onBackgroundMouseMove),this._currentTracker=this._createMouseTracker(a.pageY,this._currentImage.offsetY||0),a.preventDefault(),!1},_onBackgroundMouseUp:function(a){this._$doc.off("mousemove",
this._onBackgroundMouseMove)},_onBackgroundMouseMove:function(a){a.preventDefault();this.setPosition({offsetY:this._currentTracker(a.pageY)})},_onUploadMouseMove:function(a){var b=this._$uploadInput,c=this._$header,d=0;this._$textAd.length?c=this._$textAd:this._$responsiveNav.length&&(c=this._$responsiveNav);d=c.offset().top+c.outerHeight(!0);a.pageY<d||this._intersectRect(a.pageX,a.pageY,this._$profile)||(this._handleCallout(a),b.offset({left:a.pageX-b.width()/2,top:a.pageY-b.height()/2}))},_onWindowScroll:function(){var a;
a=this._$el[0].getBoundingClientRect();0<a.top+a.height&&(a=this._$win.scrollTop()/2,this._$image.css({transform:"translateY("+a+"px)","-moz-transform":"translateY("+a+"px)","-webkit-transform":"translateY("+a+"px)"}))},_onProfileEdit:function(){this._config.showUploader&&(this._config.isCustomUpload?(this._setState("edit-image"),this._disableBgUploader()):(this._setState("upload"),this._enableAddBgUploader(),this._track("custom_bg_impr")),this._$body.removeClass("freemium-bg-view").addClass("freemium-bg"))},
_onProfileView:function(){this._disableBgUploader();this._config.isCustomUpload||this._config.uploadOnView?!this._config.isCustomUpload&&this._config.uploadOnView?(this._setState("upload"),this._enableAddBgUploader()):this._$body.addClass("freemium-bg-view"):(this._$body.removeClass("freemium-bg"),this._setState("view"))},_setState:function(a){this._lastState=this._state;this._state=a;this._$el.attr("class","");this._$el.addClass("freemium-bg-state-"+a);"edit"===a?this._$hiddenOnEditElements.hide():
this._$hiddenOnEditElements.show()},_createMouseTracker:function(a,b){return function(c){return b+c-a}},_getMediaUrl:function(a){return 0===a.indexOf("http")?a:this._config.mediaRoot.replace("mediaId",a)},_track:function(a,b){b=b||{};b.locale=this._content.locale||"na";var c=this._isInEditMode()?"profile_edit_":"profile_view_";WebTracking.trackUserAction(c+a,b)},_isInEditMode:function(){return this._$wrap.hasClass("edit-my-profile")},_enableChangeBgUploader:function(){this._$changeArea.offset();this._$el.offset();
this._$doc.off("mousemove");this._$uploadInput.removeClass("hover-mode").addClass("disabled")},_enableAddBgUploader:function(){this._initCallout();this._$uploadInput.removeClass("disabled").addClass("hover-mode");this._$doc.on("mousemove",this._onUploadMouseMove)},_disableBgUploader:function(){this._$doc.off("mousemove");this._$uploadInput.removeClass("hover-mode").addClass("disabled")},_resetUploadInput:function(){this._$uploadInput.replaceWith(this._$uploadClone.clone());this._$uploadInput=this._$el.find(".freemium-bg-upload-input")},
_intersectRect:function(a,b,c){if(!c)return!1;var d=c.offset();return a>=d.left&&a<=d.left+c.outerWidth(!0)&&b>=d.top&&b<=d.top+c.outerHeight(!0)},_initCallout:function(){this._$info||(this._$info=this._$el.find(".info"),this._callout=new q(this._$info.get(0),{id:this._$info.data("li-tooltip-id"),orientation:"top",width:"auto",type:"hovercard-callout"}))},_handleCallout:function(a){a=this._intersectRect(a.pageX,a.pageY,this._$info);!this._calloutEngaged&&a?(this._calloutEngaged=!0,this._callout.open(),
this._track("custom_bg_info")):!a&&this._calloutEngaged&&(this._calloutEngaged=!1,this._callout.close())},_displayUploadOnView:function(){return this._config.uploadOnView&&!this._config.isCustomUpload},_getUploadedFileName:function(){var a=this._$uploadInput.val().split(/(\\|\/)/g);return a?encodeURIComponent(a.pop()):null}}});f.EVENTS_API=k;LIModules.exports("FreemiumBg",f)})(window.require);(function(){function c(b,a){return b.write('\x3cinput type\x3d"file" accept\x3d"image/jpeg, image/jpg, image/png, image/gif" name\x3d"').reference(a.get(["name"],!1),a,"h").write('"').exists(a.get(["className"],!1),a,{block:d},null).exists(a.get(["id"],!1),a,{block:e},null).write("/\x3e")}function d(b,a){return b.write('class\x3d"').reference(a.get(["className"],!1),a,"h").write('"')}function e(b,a){return b.write('id\x3d"').reference(a.get(["id"],!1),a,"h").write('"')}dust.register("tl/shared/inputs/inputFileImage",
c);return c})();(function(){dust.register("inputFileImage",dust.cache["tl/shared/inputs/inputFileImage"])})();(function(){function c(b,a){return b.write('\x3cdiv id\x3d"freemium-bg"\x3e').exists(a.get(["selfView"],!1),a,{block:d},null).write('\x3cdiv class\x3d"freemium-bg-images"\x3e\x3cimg class\x3d"freemium-bg-image" src\x3d"" alt\x3d"image"/\x3e\x3c/div\x3e').exists(a.get(["selfView"],!1),a,{block:e},null).write("\x3c/div\x3e")}function d(b,a){return b.write('\x3cform class\x3d"freemium-bg-upload-form" action\x3d"').reference(a.get(["link_media_upload"],!1),a,"h").write('" method\x3d"POST" enctype\x3d"multipart/form-data"\x3e').partial("tl/shared/inputs/inputFileImage",
a,{name:"file",className:"freemium-bg-upload-input",id:"backgroundImageFile"}).write('\x3cinput type\x3d"hidden" name\x3d"upload_info" value\x3d"').reference(a.get(["hashInfoJS"],!1),a,"h").write('"/\x3e\x3cinput type\x3d"hidden" name\x3d"persist" value\x3d"true"/\x3e\x3cinput type\x3d"hidden" name\x3d"csrfToken" value\x3d"').reference(a.get(["csrfToken"],!1),a,"h").write('"/\x3e').helper("eq",a,{block:f},{key:a.get(["lix_sign_response_enabled"],!1),value:"enabled"}).write("\x3c/form\x3e")}function f(b,
a){return b.write('\x3cinput type\x3d"hidden" name\x3d"sign_response" value\x3d"true" /\x3e')}function e(b,a){return b.write('\x3cdiv class\x3d"freemium-bg-controls"\x3e\x3cdiv class\x3d"freemium-bg-controls-edit"\x3e\x3cbutton class\x3d"freemium-bg-cancel-button" title\x3d"').reference(a.get(["i18n_cancel"],!1),a,"h").write('" type\x3d"button"\x3e\x3c/button\x3e\x3cbutton class\x3d"remove-image" type\x3d"button"\x3e').reference(a.get(["i18n_remove"],!1),a,"h").write('\x3c/button\x3e\x3clabel class\x3d"freemium-bg-change-button" for\x3d"backgroundImageFile"\x3e').reference(a.get(["i18n_change"],
!1),a,"h").write('\x3c/label\x3e\x3cbutton class\x3d"freemium-bg-save-button" type\x3d"button"\x3e').reference(a.get(["i18n_save"],!1),a,"h").write('\x3c/button\x3e\x3c/div\x3e\x3cdiv class\x3d"freemium-bg-drag-prompt"\x3e').reference(a.get(["i18n_drag_to_position"],!1),a,"h").write('\x3c/div\x3e\x3cdiv class\x3d"freemium-bg-upload-button"\x3e\x3cp class\x3d"freemium-bg-upload-button-text"\x3e\x3cstrong\x3e').reference(a.get(["i18n_add_background"],!1),a,"h").write("\x3c/strong\x3e").reference(a.get(["i18n_add_suggestion"],
!1),a,"h").write('\x3cspan class\x3d"help"\x3e').reference(a.get(["i18n_recommended_size"],!1),a,"h").write(' \x3ci class\x3d"info" data-li-tooltip-id\x3d"freemium-image-specs"\x3e\x3c/i\x3e\x3c/span\x3e\x3cdiv id\x3d"freemium-image-specs" class\x3d"callout-container"\x3e\x3cdiv class\x3d"callout-content"\x3e\x3cdiv class\x3d"callout-body"\x3e\x3cp\x3e').reference(a.get(["i18n_image_specs"],!1),a,"h").write('\x3c/p\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3c/p\x3e\x3c/div\x3e\x3cbutton class\x3d"freemium-bg-edit-button" type\x3d"button"\x3e').reference(a.get(["i18n_edit_background"],
!1),a,"h").write('\x3c/button\x3e\x3c/div\x3e\x3cdiv class\x3d"freemium-bg-spinner"\x3e\x3c/div\x3e')}dust.register("tl/apps/profile/v2/embed/freemium_profile",c);return c})();(function(){dust.register("freemium_profile",dust.cache["tl/apps/profile/v2/embed/freemium_profile"])})();!function(a){function b(){this.nodes={},this.requests={},n.addListener(a,i,n.bind(this.receiveMessage,this))}function c(b){var c,e=n.getQueryParams();b=b||{},c=b.remote,this.channel=b.channel||e[l]||"e_"+(new Date).getTime(),this.container=c?new d(this.channel,c,b.container):null,c||(this.remoteWindow=a.parent),this.remoteOrigin=this._getRemoteOrigin(c)||e[k],this.methods=b.methods||{},this.methods[j]=this._buildReady(b.ready),this.container||this._sendDiscovery()}function d(b,c,d){var e=a.document,f=this.el=e.createElement("iframe");c&&c.match(m)&&(f.name=f.id=b,f.src=this.buildFrameSrc(c),d?this.setAttributes(d):(this.setDefaults(),e.getElementsByTagName("body")[0].appendChild(f)))}function e(a,b,c){var d={method:a};b&&(d.params=b),c||(this.id=d.id=this._generateId()),this.payload=d}function f(a){function c(b){function c(a){return function(){var b=g.addRequest(a,[].slice.call(arguments));return d.send(b.payload),b}}for(var f=b.length;f--;)e[b[f]]=c(b[f]);a.methods&&d.container&&d._sendDiscovery()}var d,e=this,f=a.ready;g||(g=new b),f?a.ready=function(a){c(a),f()}:a.ready=c,d=g.addNode(a),this.$destroy=function(){g.removeNode(d)},this.$container=function(){return d.container&&d.container.el},this.VERSION="0.3.1"}var g,h="2.0",i="message",j="rpc.discover",k="e_origin",l="e_channel",m=/^https?:\/\//,n={bind:function(a,b){return function(){a.apply(b,arguments)}},isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},getQueryParams:function(){function b(a){return a.replace(/[\x00'"<\\]/g,"�")}for(var c,d,e=a.location.search.slice(1).split("&"),f={};e.length;)d=e.pop(),d&&(c=d.split("="),c.length>1&&(f[decodeURIComponent(c[0])]=b(decodeURIComponent(c[1]))));return f}};a.addEventListener?n.addListener=function(a,b,c){a.addEventListener(b,c,!1)}:a.attachEvent&&(n.addListener=function(a,b,c){a.attachEvent("on"+b,c)}),b.prototype={addNode:function(a){var b=new c(a);return this.nodes[b.channel]=b,b},addRequest:function(a,b){var c=new e(a,b);return this.requests[c.id]=c,c},removeNode:function(a){delete this.nodes[a.channel],a.destroy()},_parseJSONMessage:function(a){try{return JSON.parse(a)}catch(b){return null}},receiveMessage:function(a){var b,c;b=this._parseJSONMessage(a.data),b&&(c=this.nodes[b.channel],c&&a.origin===c.remoteOrigin&&(b.method?this.processMessage(c,b):(this.requests[b.id].process(b),delete this.requests[b.id])))},processMessage:function(a,b){var c,d=a.methods[b.method],e=a.buildCallback(this._buildResultPayload,b.id),f=a.buildCallback(this._buildErrorPayload,b.id),g=b.params;g=n.isArray(g)?g:[g],c=d.apply(a,g.concat(e,f)),c&&e(c)},_buildResultPayload:function(a,b){return{result:a,id:b}},_buildErrorPayload:function(a,b){return{error:{code:-32099,message:a},id:b}}},c.prototype={send:function(b){var c=this;b.jsonrpc=h,b.channel=c.channel,a.setTimeout(function(){c.remoteWindow.postMessage(JSON.stringify(b),c.remoteOrigin)},10)},destroy:function(){this.container&&(this.container.destroy(),this.container=null)},buildCallback:function(a,b){var c=this;return function(){c.send(a(arguments[0],b))}},_buildReady:function(a){var b=this;return function(){var c=b.container,d=c&&c.el;return b.remoteWindow||!c||(b.remoteWindow=d.contentWindow,b.remoteWindow)?void a.apply(b,arguments):void n.addListener(d,"load",function(){b.remoteWindow=d.contentWindow,a.apply(b,arguments)})}},_sendDiscovery:function(){var a=new e(j,[this._getMethodNames()],!0);this.send(a.payload)},_getMethodNames:function(){var a,b=this.methods,c=[];for(a in b)c.push(a);return c},_getRemoteOrigin:function(a){var b;return a&&"string"==typeof a?(b=a.split("/"),b[0]+"//"+b[2]):""}},d.prototype={destroy:function(){var a=this.el;a&&a.parentNode&&a.parentNode.removeChild(a),this.el=null},setAttributes:function(a){var b,c=this.el;for(b in a)"style"===b?c.style.cssText=a[b]:c[b]=a[b]},setDefaults:function(){var a=this.el.style;a.visibility="hidden",a.width="1px",a.height="1px",a.position="absolute",a.left="-999px",a.top="0"},buildFrameSrc:function(b){var c=a.location,d=c.origin?c.origin:c.protocol+"//"+c.host,e=k+"="+d,f=b.split("#"),g=f[0].split("?");return b=(g[1]?g.join("?")+"&":g[0]+"?")+e,b+="&"+l+"="+this.el.id,f[1]&&(b+="#"+f[1]),b}},e.prototype={process:function(a){a.result&&this._resultCallback?this._resultCallback(a.result):a.error&&this._errorCallback&&this._errorCallback(a.error)},result:function(a){return this._resultCallback=a,this},error:function(a){return this._errorCallback=a,this},_generateId:function(){var a=0;return function(){return++a}}()},a.Espany=f}(window);